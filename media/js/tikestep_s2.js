!function(e){"use strict";FormWizard.s2log=function(e){return{init:function(){function e(e,t,o,n){var i,l=this,a=n("LAN"),d=n("cTIP");this.saveUplog=function(e,i){if("noU"==o.hasUA){var l,d=o.dbTBname[1],s=o.dbTBname[0],c=$.Deferred(),r=function(t){lo$DB(function(a){if(0==a.kq){var c=a.e.target.result;c.objectStoreNames.contains(d)&&c.deleteObjectStore(d),c.objectStoreNames.contains(s)&&c.deleteObjectStore(s);c.createObjectStore(s,{keyPath:"id"});var r=c.createObjectStore(d,{keyPath:"id",autoIncrement:!0});r.createIndex("LogIndex","logid")}else if(1==a.kq){var f,u=new Date,g=u.getTime(),p=a.rst.transaction([s,d],"readwrite"),h=p.objectStore(s),v=p.objectStore(d),m=0,w={},_="add";t?(w={logid:t.id,dat:o.showinvisibles.val(),id:t.tc3id},_="put",f=v.put(w)):(w={logid:g,dat:o.showinvisibles.val()},f=v.add(w)),f.onsuccess=function(e){w.id||(w.id=e.target.result);var t=h.openCursor();t.onsuccess=function(e){var t,i,l=e.target.result;if(m++,l){"add"==_&&(l.value.issel=!1);l.update(l.value);l.continue()}else t=w.logid,i=w.id,o.fileinfo.tc3id=i,o.fileinfo.id=t,o.fileinfo.issave=1,o.fileinfo.issel=!0,o.fileinfo.conf=n("logCONF")(),h[_](o.fileinfo)}},p.oncomplete=function(){a.rst.close(),e.parent().fadeOut();var d=n("dogIFRM").contentWindow,s=d.chanelLog;if(s[1].log[2]=m,t){var c=n("saveDUPHIS");if(c[0].lstORfrm){c[0].lstORfrm[0].forEach(function(e,t){e.id==w.logid&&$.extend(e,o.fileinfo)});var r=[c[0].lstORfrm[0],w,c[0].lstORfrm[2]];n("resetUPLOAD")(r,!1,void 0,!1)}else $.extend(s[1].log[0][0],o.fileinfo)}else s[1].log[0]=[$.extend({},o.fileinfo)];o.logDAT[o.fileinfo.id]=[o.fileinfo,w],n("logFROMDB")(l,t?0:1),i&&"function"==typeof i&&i(1),srclocked(!1)}}})};$.when(c).then(function(e){l=e,function(){if(l){var e=$.grep(l[0],function(e,t){return e.file.name==o.fileinfo.file.name});0==e.length?r():(srclocked(!1),devDlg(1,a.js_004_17[0]).show().done(function(t){1==t?r(e[0]):i&&"function"==typeof i&&i(0)}))}else r()}()}),n("hisLOG")(c,[s])}else{var f=n("logCONF")(),u=function(e,o){t("___").comm1.uaShift(p,e,!1).then(o)},g=function(e){try{var t=JSON.parse(e);-1=="UN".indexOf(t.log[0])&&(t=null)}catch(t){e=t}return t||(toastMsg(e,"error"),srclocked(!1),null)};o.allLOGs[1]&&(f.selemps=o.allLOGs[1]);var p={fname:o.fileinfo.file.name,uptime:new Date(o.fileinfo.uptime).getTime(),conf:btoa(JSON.stringify(f)),sz:o.showinvisibles.val().length,issave:1};u("LOG_NEW_H",function(l){var d=g(l),s=$.Deferred(),c=$.Deferred(),r=function(){o.fileinfo.tc3id=d.log[1],o.fileinfo.id=d.log[1],o.fileinfo.issave=1,o.fileinfo.issel=!0,o.fileinfo.conf=f;var e,i=n("dogIFRM").contentWindow,l=i.chanelLog,a=null;if("N"==d.log[0])if(l){e=l[1].log[0];for(var s=0;s<e.length;s++)e[s].issel=!1;e.push($.extend({},o.fileinfo)),l[1].log[2]+=1}else(a=$.extend({},d)).log=[[$.extend({},o.fileinfo)],{logid:d.log[1],dat:o.showinvisibles.val(),id:d.log[1]},1];else{e=l[1].log[0];for(var s=0;s<e.length;s++)e[s].id==d.log[1]?($.extend(e[s],o.fileinfo),o.logDAT[e[s].id]&&(o.logDAT[e[s].id][1].dat=o.showinvisibles.val())):e[s].issel=!1}o.logDAT[o.fileinfo.id]=[o.fileinfo,{logid:d.log[1],dat:o.showinvisibles.val(),id:d.log[1]}],t("___").comm1.loghole(i,a,"4c4f475f53415645",{dat:o.showinvisibles.val(),logh:btoa(JSON.stringify(d.log)),logkind:1}),i.cbHwnd=function(e){c.resolve(i.chanelLog[1].log)}};d&&($.when(s,c).then(function(t,l){if(e.parent().fadeOut(),"U"==d.log[0]){var a=n("saveDUPHIS");if(a[0].lstORfrm){var s=[a[0].lstORfrm[0],{logid:d.log[1],dat:o.showinvisibles.val(),id:d.log[1]},a[0].lstORfrm[2]];n("resetUPLOAD")(s,!1,1,!1)}}n("logFROMDB")(l,0),i&&"function"==typeof i&&i(1),srclocked(!1)}),"U"==d.log[0]?(srclocked(!1),devDlg(1,a.js_004_17[0]).show().done(function(e){1==e?(srclocked(!0),p.id=d.log[1],p.tc3id=d.id,p.uptsz=p.sz-d.log[2],u("LOG_UPT_H",function(e){s.resolve(g(e))}),r()):i&&"function"==typeof i&&i(0)})):(s.resolve(),p.issel=!0,r()))})}},this.grid_attlog=function(){var t=n("verifyLOG")(),i="log_fromto_popover";if(!o[i]){var l=$("<table><tr><td>"+a.js_004_13[0]+"</td><td></td></tr><tr><td>"+a.js_004_13[1]+"</td><td></td></tr></table>").appendTo(e.find("."+i));o.log_from=$("<div/>").appendTo(l.find("tr:eq(0) > td:eq(1)")).dxDateBox({type:"date",width:120,value:t[1],onValueChanged:function(e){!0,o.allLOGs[0][1]=e.value}}).dxDateBox("instance"),o.log_to=$("<div/>").appendTo(l.find("tr:eq(1) > td:eq(1)")).dxDateBox({type:"date",width:120,value:t[2],onValueChanged:function(e){!0,o.allLOGs[0][2]=e.value}}).dxDateBox("instance"),l.popover({container:e.find("#step-2"),placement:"left",trigger:"manual",html:!0,title:"<i class='ti-light-bulb'/>"+a.js_004_14[0]+d,content:a.js_004_14[1]}),o[i]=l;$("<div/>"),$("<div/>")}o.rst_attlog?(o.rst_attlog.clearFilter(),n("uiDEV")(t)):(o.rst_attlog=e.find(".rst_attlog").dxDataGrid({keyExpr:"acno",focusedRowEnabled:!0,dataSource:t[0],allowColumnReordering:!0,allowColumnResizing:!0,columnAutoWidth:!1,showBorders:!0,selection:{mode:"multiple",selectAllMode:"page"},filterRow:{visible:!0},height:200,columns:[{caption:"#",width:50,cellTemplate:function(e,t){var n=o.rst_attlog.pageIndex();n<0&&(n=0),e.text(n*o.rst_attlog.pageSize()+t.row.rowIndex+1)}},{dataField:"acno",width:75,caption:a.js_004_25},{dataField:"ten",caption:a.js_004_26},{dataField:"logs",caption:a.js_004_32,width:75,allowFiltering:!1},{dataField:"minL",caption:a.js_004_13[2],allowFiltering:!1},{dataField:"maxL",caption:a.js_004_13[3],allowFiltering:!1}],onContentReady:function(e){o.ReadyEMP&&"function"==typeof o.ReadyEMP&&o.ReadyEMP(e)},onCellClick:function(e){"data"==e.rowType&&e.event.stopPropagation()},onSelectionChanged:function(e){!0}}).dxDataGrid("instance"),o.rst_attlog.columnOption("command:select",{visibleIndex:0,width:50}))},this.upload_attlog=function(){admin$.DEV(function(){o.ReadyEMP=function(t){o.ReadyEMP=null;var n=e.find(".rst_attlog .dx-datagrid-headers .dx-command-select .dx-select-checkbox");n.popover({container:e.find("#step-2"),placement:"right",trigger:"manual",html:!0,title:"<i class='ti-light-bulb'/>"+a.js_004_14[2]+d,content:a.js_004_14[3]}),o.selEMP_popover=n,setTimeout(function(){n.is(":visible")&&n.popover("show"),o.log_fromto_popover.popover("show")},100),o.trapHwnd&&"function"==typeof o.trapHwnd&&(o.trapHwnd(),o.trapHwnd=null)},l.grid_attlog(),helloguy.css({display:"none"})})},this.lstHis=function(t){helloguy.css("display","");var l=$.Deferred(),d=$.Deferred();if($.when(l,d).then(function(e,t){!function(e){var t=[],n=[];$.each(e[0],function(e,o){o.issel&&n.push(o.id),t.push({name:o.file.name,size:Math.floor(o.file.size/1e3),uptime:dayjs(o.uptime).format("YYYY-MM-DD HH:mm:ss"),id:o.id,tc3id:o.tc3id})}),i.option({dataSource:t,selectedRowKeys:n}),o.puSELLOG.btnSEL.option("disabled",0==n),helloguy.css("display","none")}(t)}),"noU"==o.hasUA)n("hisLOG")(d,[o.dbTBname[0]]);else{var s=e.find(".uploadattlog iframe")[0].contentWindow,c=s.chanelLog;d.resolve(c[1].log)}o.puSELLOG?(l.resolve("uI"),o.puSELLOG.show()):admin$.DEV(function(){var d={contentTemplate:function(t){var d;i=$("<div style='height:200px' class='filterE'/>").appendTo(t),d=200,(i=i.dxDataGrid({keyExpr:"id",focusedRowEnabled:!0,loadPanel:{enabled:!1},editing:{mode:"row",allowDeleting:!0,texts:{confirmDeleteMessage:""}},allowColumnReordering:!0,allowColumnResizing:!0,columnAutoWidth:!1,showBorders:!0,selection:{mode:"multiple",selectAllMode:"page"},filterRow:{visible:!0},height:d,columns:[{caption:"#",width:50,cellTemplate:function(e,t){var o=i.pageIndex();o<0&&(o=0),e.text(o*i.pageSize()+t.row.rowIndex+1)}},{dataField:"name",caption:a.js_004_15[2]},{dataField:"size",caption:"Size (Kb)",width:75,allowFiltering:!1},{dataField:"uptime",caption:a.js_004_15[3],allowFiltering:!1},{type:"buttons",width:50,buttons:[{name:"delete",icon:"ti ti-trash",cssClass:"removehislog"}]}],onContentReady:function(e){},onCellClick:function(e){"data"==e.rowType&&e.event.stopPropagation()},onSelectionChanged:function(e){o.puSELLOG.btnSEL.option("disabled",0==i.getSelectedRowKeys().length)},onRowRemoving:function(t){var i=t.key,l=t.component,d=(l.getRowIndexByKey(i),devDlg(4,a.js_004_16[2]));t.cancel=$.Deferred(function(i){d.show().done(function(d){6==d?(srclocked(!0),i.resolve(!1),n("delHISLOG")(function(i){var d=e.find(".uploadattlog .hislog-list tbody");if(d.length>0)d.find("tr[idx='"+t.data.id+"'] .bntrmv").trigger("click",[-1*parseInt(t.data.id)]),toastMsg(a.js_003_ok,"success");else{var s=function(){o.fileinfo&&o.fileinfo.id==t.data.id&&n("cleanHIS")(null,!1);var e=l.option("dataSource").length;e<2&&n("logFROMDB")([[],,e],0),toastMsg(a.js_003_ok,"success")};if(i&&"function"==typeof i){var c=$.Deferred();$.when(c).then(function(e){s(),srclocked(!1)}),i(-1*t.data.id,c)}else s(),srclocked(!1)}},t.data.id,t.data.tc3id)):i.resolve(!0)})})},onRowRemoved:function(e){o.puSELLOG.btnSEL.option("disabled",0==e.component.option("dataSource").length)}}).dxDataGrid("instance")).columnOption("command:select",{visibleIndex:0,width:50}),l.resolve("GRID")},onContentReady:function(e){e.component._$popupContent.css("padding","0px")},onShown:function(e){},shading:!0,showTitle:!0,title:a.js_004_15[1],visible:!1,dragEnabled:!1,closeOnOutsideClick:!1,showCloseButton:!0,toolbarItems:[{widget:"dxButton",toolbar:"bottom",location:"before",options:{icon:"ti ti-check",text:a.js_004_3,disabled:!0,onClick:function(e){srclocked(!0),o.puSELLOG.hide();var t={},l=[],a=-1;$.map(i.option("dataSource"),function(e,o){t[e.id]=!1}),$.map(i.getSelectedRowKeys(),function(e,n){t[e]=!0,l.push(parseInt(e)),o.logDAT[e]&&(a=e)});var d=$.Deferred();$.when(d).then(function(e){var t=n("resetUPLOAD")(e,!0,void 0,!0);n("uiDEV")(t),o.rst_attlog?o.ReadyEMP=function(e){o.ReadyEMP=null,srclocked(!1)}:srclocked(!1)}),"noU"==o.hasUA?n("hisLOG")(d,o.dbTBname,{issel:!0},t):n("hisLOG")(d,["LOG_IN_LST",l],{id:-1!=a?a:l[l.length-1]},t)},onContentReady:function(e){o.puSELLOG.btnSEL=e.component}}},{widget:"dxButton",toolbar:"bottom",location:"after",options:{text:a.js_003_1,onClick:function(e){o.puSELLOG.hide()}}}]};"phone"==DevExpress.devices._realDevice.deviceType?d.fullScreen=!0:(d.maxWidth=600,d.height="auto"),o.puSELLOG=$("<div/>").appendTo(t).dxPopup(d).dxPopup("instance"),o.puSELLOG.show()})}}return e.prototype.publicSharedVar="quux",e.prototype.publicSharedMethod=function(e){},e}()}}()}();