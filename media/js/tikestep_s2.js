!function(e){"use strict";FormWizard.s2log={init:function(){function e(e,t,o,i){var n,l=this,a=i("LAN"),s=i("cTIP"),d=null,c=function(e){var t=[],o=[];return $.each(e[0],(function(e,i){i.issel&&o.push(i.id),t.push({name:i.file.name,size:Math.floor(i.file.size/1e3),uptime:dayjs(i.uptime).format("YYYY-MM-DD HH:mm:ss"),id:i.id,tc3id:i.tc3id})})),[t,o]},r=function(e){var t=c(e),i=t[0],l=t[1];n.selHWND=function(e){n.selHWND=null,o.puSELLOG.btnSEL.option("disabled",!0)},n.option({dataSource:i,selectedRowKeys:l})},f=function(t,l){(n=n.dxDataGrid({dataSource:l[0],selectedRowKeys:l[1],keyExpr:"id",focusedRowEnabled:!0,loadPanel:{enabled:!1},editing:{mode:"row",allowDeleting:!0,texts:{confirmDeleteMessage:""}},allowColumnReordering:!0,allowColumnResizing:!0,columnAutoWidth:!1,showBorders:!0,selection:{mode:"multiple",selectAllMode:"page"},filterRow:{visible:!0},height:t,columns:[{caption:"#",width:50,cellTemplate:function(e,t){var o=n.pageIndex();o<0&&(o=0),e.text(o*n.pageSize()+t.row.rowIndex+1)}},{dataField:"name",caption:a.js_004_15[2]},{dataField:"size",caption:"Size (Kb)",width:75,allowFiltering:!1},{dataField:"uptime",caption:a.js_004_15[3],allowFiltering:!1},{type:"buttons",width:50,buttons:[{name:"delete",icon:"ti ti-trash",cssClass:"removehislog"}]}],onContentReady:function(e){d&&"function"==typeof d&&d(e)},onCellClick:function(e){"data"==e.rowType&&e.event.stopPropagation()},onSelectionChanged:function(e){e.component.selHWND&&"function"==typeof e.component.selHWND?e.component.selHWND(e):o.puSELLOG.btnSEL.option("disabled",0==n.getSelectedRowKeys().length)},onRowRemoving:function(t){var n=t.key,l=t.component,s=(l.getRowIndexByKey(n),devDlg(4,a.js_004_16[2]));t.cancel=$.Deferred((function(n){s.show().done((function(s){if(6==s){srclocked(!0),n.resolve(!1);var d=function(n){var s=e.find(".uploadattlog .hislog-list tbody");if(s.length>0){var d=s.find("tr[idx='"+t.data.id+"'] .bntrmv");if(d.length>0)d.trigger("click",[-1*parseInt(t.data.id)]);else if(n&&"function"==typeof n){var c=$.Deferred();$.when(c).then((function(e){srclocked(!1)})),n(-1*t.data.id,c)}else srclocked(!1);toastMsg(a.js_003_ok,"success")}else{var r=function(){o.fileinfo&&o.fileinfo.id==t.data.id&&i("cleanHIS")(null,!1);var e=l.option("dataSource").length;e<2&&i("logFROMDB")([[],,e],0),toastMsg(a.js_003_ok,"success")};n&&"function"==typeof n?(c=$.Deferred(),$.when(c).then((function(e){r(),srclocked(!1)})),n(-1*t.data.id,c)):(r(),srclocked(!1))}};i("delHISLOG")(d,t.data.id,t.data.tc3id)}else n.resolve(!0)}))}))},onRowRemoved:function(e){o.puSELLOG.btnSEL.option("disabled",0==n.getSelectedRowKeys().length)}}).dxDataGrid("instance")).columnOption("command:select",{visibleIndex:0,width:50})};function u(t){o.ReadyEMP=null;var i=e.find(".rst_attlog .dx-datagrid-headers .dx-command-select .dx-select-checkbox");i.popover({container:e.find("#step-2"),placement:"right",trigger:"manual",html:!0,title:"<i class='ti-light-bulb'/>"+a.js_004_14[2]+s,content:a.js_004_14[3]}),o.selEMP_popover=i,setTimeout((function(){i.is(":visible")&&i.popover("show"),o.log_fromto_popover.popover("show")}),100),o.trapHwnd&&"function"==typeof o.trapHwnd&&(o.trapHwnd(),o.trapHwnd=null)}this.saveUplog=function(e,n,l){var s=this;if("noU"==o.hasUA){var d,c=o.dbTBname[1],r=o.dbTBname[0],f=$.Deferred(),u=function(t){lo$DB((function(l){if(0==l.kq){var a=l.e.target.result;a.objectStoreNames.contains(c)&&a.deleteObjectStore(c),a.objectStoreNames.contains(r)&&a.deleteObjectStore(r),a.createObjectStore(r,{keyPath:"id"}),a.createObjectStore(c,{keyPath:"id",autoIncrement:!0}).createIndex("LogIndex","logid")}else if(1==l.kq){var f,u=(new Date).getTime(),p=l.rst.transaction([r,c],"readwrite"),g=p.objectStore(r),v=p.objectStore(c),h=0,m={},w="add",_=function(e,t){o.fileinfo.tc3id=t,o.fileinfo.id=e,o.fileinfo.issave=1,o.fileinfo.issel=!0,o.fileinfo.conf=i("logCONF")(),g[w](o.fileinfo)};t?(m={logid:t.id,dat:o.showinvisibles.val(),id:t.tc3id},w="put",f=v.put(m)):(m={logid:u,dat:o.showinvisibles.val()},f=v.add(m)),f.onsuccess=function(e){m.id||(m.id=e.target.result),g.openCursor().onsuccess=function(e){var t=e.target.result;t?(h++,("add"==w||!s&&o.fileinfo.file.name!=t.value.file.name)&&(t.value.issel=!1),t.update(t.value),t.continue()):_(m.logid,m.id)}},p.oncomplete=function(){l.rst.close(),e.parent().css("display","none");var a=i("dogIFRM").contentWindow.chanelLog;if(a[1].log[2]=h,t){var s=i("saveDUPHIS");if(s[0].lstORfrm){s[0].lstORfrm[0].forEach((function(e,t){e.id==m.logid&&$.extend(!0,e,o.fileinfo)}));var c=[s[0].lstORfrm[0],m,s[0].lstORfrm[2]];i("resetUPLOAD")(c,!1,void 0,!1)}else $.extend(a[1].log[0][0],o.fileinfo)}else a[1].log[0]=[$.extend(!0,{},o.fileinfo)];o.logDAT[o.fileinfo.id]=[o.fileinfo,m],i("logFROMDB")(d,t?0:1),n&&"function"==typeof n&&n.call([t?"U":"N"],1),srclocked(!1)}}}))},p=function(){if(d){var e=$.grep(d[0],(function(e,t){return e.file.name==o.fileinfo.file.name}));if(0==e.length)u();else if(l&&"plsDEL"===l.s3)u(e[0]);else{srclocked(!1);var t=devDlg,s=!0,c=function(){return l&&l.dupmsg?l&&l.dupmsg:a.js_004_17[0]};l&&l.s3&&(t=i("dlgs3"),s=!1),t(1,"<div class='text-center'>"+c()+"</div>",s?void 0:l).show().done((function(t){1==t?u(e[0]):n&&"function"==typeof n&&n(-2==t?-2:0)}))}}else u()};$.when(f).then((function(e){d=e,p()})),i("hisLOG")(f,[r])}else{var g=i("logCONF")(),v=function(e,o){t("___").comm1.uaShift(m,e,!1).then(o)},h=function(e){try{var t=JSON.parse(e);-1=="UN".indexOf(t.log[0])&&(t=null)}catch(t){e=t}return t||(toastMsg(e,"error"),srclocked(!1),null)};o.allLOGs[1]&&(g.selemps=o.allLOGs[1]);var m={fname:o.fileinfo.file.name,uptime:new Date(o.fileinfo.uptime).getTime(),conf:btoa(JSON.stringify(g)),sz:o.showinvisibles.val().length,issave:1};v("LOG_NEW_H",(function(d){var c=h(d),r=$.Deferred(),f=$.Deferred(),u=function(){o.fileinfo.tc3id=c.log[1],o.fileinfo.id=c.log[1],o.fileinfo.issave=1,o.fileinfo.issel=!0,o.fileinfo.conf=g;var e,n=i("dogIFRM").contentWindow,l=n.chanelLog,a=null;if("N"==c.log[0])if(l){e=l[1].log[0];for(var d=0;d<e.length;d++)e[d].issel=!1;e.push($.extend(!0,{},o.fileinfo)),l[1].log[2]+=1}else(a=$.extend(!0,{},c)).log=[[$.extend(!0,{},o.fileinfo)],{logid:c.log[1],dat:o.showinvisibles.val(),id:c.log[1]},1];else for(e=l[1].log[0],d=0;d<e.length;d++)e[d].id==c.log[1]?($.extend(!0,e[d],o.fileinfo),o.logDAT[e[d].id]&&(o.logDAT[e[d].id][1].dat=o.showinvisibles.val())):("N"==c.log[0]||!s&&c.log[1]!=e[d].id)&&(e[d].issel=!1);o.logDAT[o.fileinfo.id]=[o.fileinfo,{logid:c.log[1],dat:o.showinvisibles.val(),id:c.log[1]}],t("___").comm1.loghole(n,a,"4c4f475f53415645",{dat:o.showinvisibles.val(),logh:btoa(JSON.stringify(c.log)),logkind:1,ori:window.location.origin+";*"}),n.cbHwnd=function(e){f.resolve(n.chanelLog[1].log)}};if(c)if($.when(r,f).then((function(l,a){if(e.parent().css("display","none"),"U"==c.log[0]){var s=i("saveDUPHIS");if(s[0].lstORfrm){var d=[s[0].lstORfrm[0],{logid:c.log[1],dat:o.showinvisibles.val(),id:c.log[1]},s[0].lstORfrm[2]];i("resetUPLOAD")(d,!1,1,!1)}}i("logFROMDB")(a,0),n&&"function"==typeof n&&n.call([c.log[0]],1);var r=t("alog");r.key||(r.addr=c.addr,r.key=c.key),srclocked(!1)})),"U"==c.log[0]){var p=function(e){srclocked(!1);var t=devDlg,o=!0,n=function(){return l&&l.dupmsg?l.dupmsg:a.js_004_17[0]};l&&l.s3&&(t=i("dlgs3"),o=!1),t(1,"<div class='text-center'>"+n()+"</div>",o?void 0:l).show().done(e)},w=function(e){srclocked(!0),m.id=c.log[1],m.tc3id=c.id,m.uptsz=m.sz-c.log[2],m.lstORfrm=s?1:0,v("LOG_UPT_H",(function(e){r.resolve(h(e))})),u()};l&&"plsDEL"===l.s3?w():p((function(e){1==e?w():(r.reject(),n&&"function"==typeof n&&n(-2==e?-2:0))}))}else r.resolve(),m.issel=!0,u()}))}},this.grid_attlog=function(){var t=i("verifyLOG")(),n="log_fromto_popover";if(!o[n]){o.ReadyEMP=u;var l=$("<table><tr><td>"+a.js_004_13[0]+"</td><td></td></tr><tr><td>"+a.js_004_13[1]+"</td><td></td></tr></table>").appendTo(e.find("."+n));function d(e){var t=e.value;if(t)try{t=is$Date(DevExpress.localization.formatDate(e.value,"yyyy-MM-dd").split("-"))}catch(e){t=!1}if(!1===t){var o=e.previousValue;o&&is$Date(o)||(o=null),e.component.option("value",o)}}o.log_from=$("<div/>").appendTo(l.find("tr:eq(0) > td:eq(1)")).dxDateBox({type:"date",width:120,value:null,placeholder:DevExpress.localization.formatDate(t[1],"shortdate"),onValueChanged:function(e){d(e),o.stepHis.isTiCo=1,o.allLOGs[0][3]=e.value}}).dxDateBox("instance"),o.log_to=$("<div/>").appendTo(l.find("tr:eq(1) > td:eq(1)")).dxDateBox({type:"date",width:120,value:null,placeholder:DevExpress.localization.formatDate(t[2],"shortdate"),onValueChanged:function(e){d(e),o.stepHis.isTiCo=1,o.allLOGs[0][4]=e.value}}).dxDateBox("instance"),l.popover({container:e.find("#step-2"),placement:"left",trigger:"manual",html:!0,title:"<i class='ti-light-bulb'/>"+a.js_004_14[0]+s,content:a.js_004_14[1]}),o[n]=l}o.rst_attlog?(o.rst_attlog.clearFilter(),i("uiDEV")(t)):(o.rst_attlog=e.find(".rst_attlog").dxDataGrid({keyExpr:"acno",focusedRowEnabled:!0,dataSource:t[0],allowColumnReordering:!0,allowColumnResizing:!0,columnAutoWidth:!1,showBorders:!0,selection:{mode:"multiple",selectAllMode:"page"},filterRow:{visible:!0},height:250,columns:[{caption:"#",width:50,cellTemplate:function(e,t){var i=o.rst_attlog.pageIndex();i<0&&(i=0),e.text(i*o.rst_attlog.pageSize()+t.row.rowIndex+1)}},{dataField:"acno",width:75,caption:a.js_004_25},{dataField:"ten",caption:a.js_004_26},{dataField:"logs",caption:a.js_004_32,width:75,allowFiltering:!1},{dataField:"minL",caption:a.js_004_13[2],allowFiltering:!1},{dataField:"maxL",caption:a.js_004_13[3],allowFiltering:!1}],onContentReady:function(e){o.ReadyEMP&&"function"==typeof o.ReadyEMP&&o.ReadyEMP(e)},onCellClick:function(e){"data"==e.rowType&&e.event.stopPropagation()},onSelectionChanged:function(e){o.stepHis.isTiCo=1}}).dxDataGrid("instance"),o.rst_attlog.columnOption("command:select",{visibleIndex:0,width:50}))},this.upload_attlog=function(){admin$.DEV((function(){o.ReadyEMP=u,l.grid_attlog(),helloguy.css({display:"none"})}))},this.lstHis=function(t,l){helloguy.css("display","");var s,u=200,p=$.Deferred(),g=$.Deferred();if($.when(p,g).then((function(e,t){d=function(e){d=null,o.puSELLOG.show(),srclocked(!1)},"GRID"==e?(f(u,c(t)),o.puSELLOG.btnSEL=s):r(t,e)})),"noU"==o.hasUA)i("hisLOG")(g,[o.dbTBname[0]]);else{var v=e.find(".uploadattlog iframe")[0].contentWindow.chanelLog;g.resolve(v[1].log)}o.puSELLOG?p.resolve("uI"):admin$.DEV((function(){var e={contentTemplate:function(e){n=$("<div style='height:"+u+"px' class='filterE'/>").appendTo(e),p.resolve("GRID")},onContentReady:function(e){e.component._$popupContent.css("padding","0px")},onShown:function(e){n.selHWND=null},shading:!0,showTitle:!0,title:a.js_004_15[1],visible:!1,deferRendering:!1,dragEnabled:!0,closeOnOutsideClick:!1,showCloseButton:!0,toolbarItems:[{widget:"dxButton",toolbar:"bottom",location:"before",options:{icon:"ti ti-check",text:a.js_004_3,disabled:!0,onClick:function(e){srclocked(!0);var t={},a=[],s=-1;if($.map(n.option("dataSource"),(function(e,o){t[e.id]=!1})),$.map(n.getSelectedRowKeys(),(function(e,i){t[e]=!0,a.push(parseInt(e)),o.logDAT[e]&&(s=e)})),1==a.length&&!l&&o.fileinfo&&a.indexOf(o.fileinfo.id)>-1)return srclocked(!1),void o.puSELLOG.hide();var d=$.Deferred();$.when(d).then((function(e){o.stepHis.isTiCo=1;var t=i("resetUPLOAD")(e,!0,void 0,!0);i("uiDEV")(t),o.rst_attlog?o.ReadyEMP=function(e){o.ReadyEMP=null,srclocked(!1)}:srclocked(!1)})),"noU"==o.hasUA?i("hisLOG")(d,o.dbTBname,{issel:!0},t):i("hisLOG")(d,["LOG_IN_LST",a],{id:-1!=s?s:a[a.length-1]},t),o.puSELLOG.hide()},onContentReady:function(e){s=e.component}}},{widget:"dxButton",toolbar:"bottom",location:"after",options:{text:a.js_003_1,onClick:function(e){o.puSELLOG.hide()}}}]};"phone"==DevExpress.devices._realDevice.deviceType?e.fullScreen=!0:(e.maxWidth=600,e.height="auto"),o.puSELLOG=$("<div/>").appendTo(t).dxPopup(e).dxPopup("instance")}))}}return e.prototype.publicSharedVar="quux",e.prototype.publicSharedMethod=function(e){},e}()}}();